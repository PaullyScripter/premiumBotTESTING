<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Premium Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      background: #020617;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
      text-align: center;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
    }
    p {
      color: #9ca3af;
      margin-top: 0;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
      cursor: pointer;
      margin: 0.5rem 0;
    }
    #login-btn {
      background: #5865f2;
      color: white;
    }
    #logout-btn {
      background: #4b5563;
      color: white;
    }
    #purchase-btn {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }
    #user-card {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: #020617;
      border: 1px solid #1f2937;
      display: none;
    }
    #user-avatar {
      width: 72px;
      height: 72px;
      border-radius: 999px;
      display: block;
      margin: 0 auto 0.75rem auto;
    }
    .tag {
      display: inline-block;
      margin-top: 0.25rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #0f172a;
      color: #22c55e;
      border: 1px solid #14532d;
    }
    #status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #f97316;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>My Premium Discord Bot</h1>
    <p>Log in with Discord to see your account and buy premium with crypto.</p>

    <button id="login-btn">Login with Discord</button>
    <button id="logout-btn" style="display:none;">Logout</button>

    <div id="user-card">
      <img id="user-avatar" src="" alt="Discord avatar" />
      <div id="user-name"></div>
      <div id="user-id" style="font-size:0.8rem;color:#6b7280;"></div>
      <div id="premium-badge" class="tag" style="display:none;">Premium</div>

      <div style="margin-top: 1rem;">
        <button id="purchase-btn">Purchase Premium with Crypto</button>
      </div>
      <div id="status"></div>
    </div>
  </div>

  <script>
    // For local testing, this is your FastAPI backend
    const BACKEND_URL = "http://localhost:8000";

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userCard = document.getElementById("user-card");
    const userAvatar = document.getElementById("user-avatar");
    const userName = document.getElementById("user-name");
    const userId = document.getElementById("user-id");
    const premiumBadge = document.getElementById("premium-badge");
    const purchaseBtn = document.getElementById("purchase-btn");
    const statusEl = document.getElementById("status");

    loginBtn.addEventListener("click", () => {
      window.location.href = `${BACKEND_URL}/auth/discord/login`;
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await fetch(`${BACKEND_URL}/auth/logout`, {
          method: "POST",
          credentials: "include",
        });
      } catch (e) {
        console.error(e);
      }
      location.reload();
    });

    purchaseBtn.addEventListener("click", async () => {
      statusEl.textContent = "Creating crypto invoice (fake for now)...";
      try {
        const res = await fetch(`${BACKEND_URL}/api/create-invoice`, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ plan: "premium_monthly" }),
        });

        if (!res.ok) throw new Error("Failed to create invoice");

        const data = await res.json();
        if (data.invoice_url) {
          window.location.href = data.invoice_url; // fake payment URL for now
        } else {
          statusEl.textContent = "Could not get invoice URL.";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error while creating invoice.";
      }
    });

    async function fetchCurrentUser() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/me`, {
          credentials: "include",
        });

        if (!res.ok) {
          userCard.style.display = "none";
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
          return;
        }

        const user = await res.json();

        userCard.style.display = "block";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";

        userAvatar.src = user.avatar_url;
        userName.textContent = `${user.username}${
          user.discriminator ? "#" + user.discriminator : ""
        }`;
        userId.textContent = `ID: ${user.id}`;

        if (user.premium) {
          premiumBadge.style.display = "inline-block";
          statusEl.textContent = "You already have premium ðŸŽ‰";
        } else {
          premiumBadge.style.display = "none";
          statusEl.textContent = "You do not have premium yet.";
        }
      } catch (err) {
        console.error(err);
      }
    }

    fetchCurrentUser();
  </script>
</body>
</html>
